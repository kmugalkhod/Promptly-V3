# Story 1.1: Create File Relevance Scoring System

## Status

Review

## Story

**As a** Chat Agent,
**I want** files scored by relevance to the user's request,
**so that** I receive the most useful files first without searching.

## Acceptance Criteria

1. `RelevanceScorer` class exists in `services/context_builder.py`
2. `score_file(file_path: str, file_content: str, query: str) -> float` returns 0.0-1.0 score
3. Scoring considers: keyword matches, file type priority (.tsx > .ts > .css), component name matches
4. Page files (`page.tsx`) receive bonus score for route-related queries
5. Recently modified files (tracked per session) receive recency bonus
6. Unit tests verify scoring logic with sample files and queries

## Tasks / Subtasks

- [x] Task 1: Create `services/context_builder.py` file (AC: 1)
  - [x] Create new file at `services/context_builder.py`
  - [x] Add module docstring explaining purpose
  - [x] Add necessary imports (re, dataclasses, typing)

- [x] Task 2: Implement `RelevanceScorer` class (AC: 2, 3)
  - [x] Create `RelevanceScorer` class with `__init__` accepting optional config
  - [x] Implement `score_file(file_path: str, file_content: str, query: str) -> float` method
  - [x] Implement `_extract_keywords(query: str) -> list[str]` helper method
  - [x] Implement `_calculate_keyword_score(content: str, keywords: list[str]) -> float`
  - [x] Implement `_get_file_type_priority(file_path: str) -> float` with priorities:
    - `.tsx` files: 1.0
    - `.ts` files: 0.8
    - `.css` / `.scss` files: 0.6
    - Other files: 0.4

- [x] Task 3: Add component name matching (AC: 3)
  - [x] Extract component names from file path (e.g., `Header.tsx` -> `Header`)
  - [x] Check if component name appears in query (case-insensitive)
  - [x] Add bonus score (0.3) for component name matches

- [x] Task 4: Add page file bonus for route queries (AC: 4)
  - [x] Detect if query mentions routes/pages (keywords: "page", "route", "/", "navigate")
  - [x] Detect if file is a page file (`page.tsx`, `layout.tsx`)
  - [x] Add bonus score (0.2) for page files when route-related query

- [x] Task 5: Add recency tracking (AC: 5)
  - [x] Add `recent_files: list[str]` parameter to scorer
  - [x] Implement recency bonus: files recently modified get +0.15 score
  - [x] Most recent file gets highest bonus, decreasing for older modifications

- [x] Task 6: Write unit tests (AC: 6)
  - [x] Create test file (location TBD based on project structure)
  - [x] Test basic keyword matching
  - [x] Test file type priority scoring
  - [x] Test component name matching
  - [x] Test page file bonus
  - [x] Test recency bonus
  - [x] Test edge cases (empty query, empty content, unknown file types)

## Dev Notes

### Source Files to Reference

| File | Purpose |
|------|---------|
| `services/session_manager.py` | Existing pattern for dataclasses and service classes |
| `tools.py` | Existing pattern for file path handling |

### Existing Code Patterns

From `services/session_manager.py`:
- Uses `@dataclass` for data structures
- Uses type hints throughout
- Uses `Optional` from typing for optional parameters
- Pattern: `field(default_factory=list)` for mutable defaults

### File Type Priority Rationale

Priority order based on likelihood of containing relevant code:
1. `.tsx` (1.0) - React components, most user-facing code
2. `.ts` (0.8) - TypeScript utilities, hooks, types
3. `.css/.scss` (0.6) - Styling, relevant for visual changes
4. Other (0.4) - Config files, less likely to need modification

### Keyword Extraction Strategy

Simple approach (no external dependencies):
1. Lowercase the query
2. Split on whitespace and punctuation
3. Remove common stop words ("the", "a", "an", "to", "make", "change")
4. Keep words >= 3 characters

### Scoring Formula

```python
final_score = (
    keyword_score * 0.4 +      # 40% weight on keyword matches
    file_type_priority * 0.25 + # 25% weight on file type
    component_match * 0.2 +     # 20% weight on component name match
    route_bonus * 0.1 +         # 10% weight on page file bonus
    recency_bonus * 0.05        # 5% weight on recency
)
# Clamp to 0.0-1.0 range
```

### Testing

**Test Location:** Create `tests/` directory if not exists, add `test_context_builder.py`

**Test Framework:** Use pytest (standard Python testing)

**Sample Test Data:**
```python
# Sample files for testing
SAMPLE_FILES = {
    "components/Header.tsx": "export function Header() { return <header>...</header> }",
    "app/page.tsx": "export default function Home() { return <main>...</main> }",
    "lib/utils.ts": "export function cn(...) { ... }",
    "styles/globals.css": ".container { ... }"
}

# Sample queries
SAMPLE_QUERIES = [
    ("make the header blue", "components/Header.tsx"),  # Should rank highest
    ("change homepage", "app/page.tsx"),  # Should rank highest
    ("update styling", "styles/globals.css"),  # Should rank high
]
```

## Integration Verification

- [x] IV1: Existing `ChatSession` class unchanged - no imports added to session_manager.py yet
- [x] IV2: `RelevanceScorer` can be instantiated and tested independently
- [x] IV3: Scoring 50 files completes in <50ms (verify with timing test) - Passed: 0.08s for 37 tests including 50-file performance test

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation | SM Agent |
| 2025-01-12 | 1.1 | Implementation complete - all tasks done | Dev Agent |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- No debug issues encountered
- All 37 unit tests pass
- Performance test confirms <50ms for 50 files

### Completion Notes List

- Created `services/context_builder.py` with `RelevanceScorer` class
- Implemented keyword extraction with stop word filtering
- Implemented file type priority scoring (.tsx > .ts > .css > other)
- Implemented component name matching with 0.3 bonus
- Implemented page file bonus (0.2) for route-related queries
- Implemented recency bonus with exponential decay (0.15 max, 0.7 decay factor)
- Created comprehensive test suite with 37 tests covering all functionality
- Used importlib for test imports to avoid e2b dependency issue

### File List

| File | Action |
|------|--------|
| `services/context_builder.py` | Created |
| `tests/__init__.py` | Created |
| `tests/test_context_builder.py` | Created |

## QA Results

(To be filled after QA review)
